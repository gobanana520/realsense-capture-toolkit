<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RealSense Camera Capture Toolkit</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <style>
      body {
        background-color: #f8f9fa;
      }
      .container {
        margin-top: 20px;
      }
      .card {
        margin-bottom: 20px;
      }
      #stream-frame {
        width: 100%;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      }
      .left-side,
      .right-side {
        display: flex;
        flex-direction: column;
      }
      .left-side .card,
      .right-side .card {
        flex-grow: 1;
      }

      .scrollable-content {
        overflow-y: auto;
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ddd;
        background-color: #fff;
        max-height: 50vh; /* Set max-height as a percentage of the viewport height */
      }
      .fixed-status {
        background: white;
        z-index: 10;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Title -->
      <div class="row mb-4">
        <div class="col text-center">
          <h1>RealSense Camera Capture Toolkit</h1>
        </div>
      </div>

      <div class="row">
        <!-- Left Side -->
        <div class="col-lg-8 d-flex flex-column left-side">
          <!-- Block 1: Connected Devices -->
          <div class="card">
            <div class="card-header">Connected Devices</div>
            <div class="card-body">
              <select id="device-select" class="form-select"></select>
            </div>
          </div>

          <!-- Block 2: Control Actions -->
          <div class="card">
            <div class="card-header">Control Actions</div>
            <div class="card-body">
              <div class="mb-3">
                <button id="start-stream-btn" class="btn btn-success me-2">
                  Start Streaming
                </button>
                <button id="stop-stream-btn" class="btn btn-danger me-2">
                  Stop Streaming
                </button>
                <button id="get-calibration-btn" class="btn btn-info">
                  Get Calibration Info
                </button>
              </div>
              <div class="input-group">
                <input
                  type="text"
                  id="folder-name"
                  class="form-control"
                  placeholder="Enter sub-folder name"
                />
                <button id="capture-btn" class="btn btn-primary">
                  Capture
                </button>
              </div>
            </div>
          </div>

          <!-- Block 3: Streaming Image Visualization -->
          <div class="card flex-grow-1">
            <div class="card-header">Streaming Image</div>
            <div class="card-body text-center">
              <img
                id="stream-frame"
                src="{{ url_for('video_feed') }}"
                alt="Stream Frame"
                class="img-fluid"
              />
            </div>
          </div>
        </div>

        <!-- Right Side -->
        <div class="col-lg-4 d-flex flex-column right-side">
          <!-- Block 4: Information Display -->
          <div class="card h-100 d-flex flex-column">
            <div class="card-header">Information</div>
            <div class="card-body d-flex flex-column">
              <div id="device-info" class="fixed-status">
                Streaming status will appear here
              </div>
              <div id="log-info" class="scrollable-content"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <!-- Custom JS -->
    <script>
      function getCurrentTimestamp() {
        const now = new Date();
        return now.toLocaleString(); // returns current date and time as a string
      }

      function loadLogs() {
        const logInfo = document.getElementById("log-info");
        const logs = JSON.parse(localStorage.getItem("logs")) || [];
        logs.forEach((log) => {
          const p = document.createElement("p");
          p.textContent = log.text;
          p.className = log.type === "error" ? "text-danger" : "text-success";
          logInfo.appendChild(p);
        });
        scrollToBottom(logInfo);
      }

      function saveLog(text, type) {
        const logs = JSON.parse(localStorage.getItem("logs")) || [];
        logs.push({ text, type });
        localStorage.setItem("logs", JSON.stringify(logs));
      }

      function scrollToBottom(element) {
        element.scrollTop = element.scrollHeight;
      }

      async function loadDevices() {
        const response = await fetch("/devices");
        const devices = await response.json();
        const deviceSelect = document.getElementById("device-select");
        const deviceInfo = document.getElementById("device-info");

        devices.forEach((device) => {
          const option = document.createElement("option");
          option.value = device.serial;
          option.text = `${device.name} (${device.serial})`;
          deviceSelect.add(option);
        });

        if (devices.length > 0) {
          deviceInfo.textContent = `Connected device: ${devices[0].name} (${devices[0].serial})`;
        } else {
          deviceInfo.textContent = "No devices connected.";
        }
      }

      document
        .getElementById("start-stream-btn")
        .addEventListener("click", () => {
          const serial = document.getElementById("device-select").value;
          fetch("/start_stream", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ serial }),
          }).then(() => {
            const selectedDevice =
              document.getElementById("device-select").selectedOptions[0].text;
            document.getElementById(
              "device-info"
            ).textContent = `Streaming from device: ${selectedDevice}`;
            logMessage(
              `Started streaming from device: ${selectedDevice}`,
              "success"
            );
          });
        });

      document
        .getElementById("stop-stream-btn")
        .addEventListener("click", () => {
          fetch("/stop_stream", { method: "POST" }).then(() => {
            document.getElementById("device-info").textContent =
              "Streaming stopped.";
            logMessage("Streaming stopped.", "success");
          });
        });

      document
        .getElementById("capture-btn")
        .addEventListener("click", async () => {
          const folderName = document.getElementById("folder-name").value;
          const response = await fetch("/capture", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ folder_name: folderName }),
          });

          if (response.ok) {
            const data = await response.json();
            const timestamp = data.timestamp;
            logMessage(`Capture_${timestamp} saved!!!`, "success");
          } else {
            logMessage("Capture failed.", "error");
          }
        });

      document
        .getElementById("get-calibration-btn")
        .addEventListener("click", async () => {
          const serial = document.getElementById("device-select").value;
          const response = await fetch("/get_calibration_info", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ serial }),
          });

          if (response.ok) {
            const data = await response.json();
            logMessage(`Calibration info saved as ${data.filename}`, "success");
          } else {
            logMessage("Failed to save calibration info.", "error");
          }
        });

      function logMessage(message, type) {
        const logInfo = document.getElementById("log-info");
        const timestamp = getCurrentTimestamp();
        const logText = `[${timestamp}] ${message}`;
        const p = document.createElement("p");
        p.textContent = logText;
        p.className = type === "error" ? "text-danger" : "text-success";
        logInfo.appendChild(p);
        saveLog(logText, type); // Save log to localStorage
        scrollToBottom(logInfo); // Scroll to bottom after adding new log
      }

      // Load devices and logs on page load
      loadDevices();
      loadLogs();
    </script>
  </body>
</html>
